<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>地下街探索 (Undercity Tracker)</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel (for JSX) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        /* 基本スタイル調整 */
        body {
            background-color: #1c1917;
            color: #d6d3d1;
            font-family: sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        /* スクロールバーのカスタマイズ */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        ::-webkit-scrollbar-track {
            background: #1c1917;
        }
        ::-webkit-scrollbar-thumb {
            background: #44403c;
            border-radius: 3px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #57534e;
        }
        /* iOSのセーフエリア対応 */
        .pb-safe-area {
            padding-bottom: env(safe-area-inset-bottom, 20px);
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // --- Icons (Lucide React & Custom) ---
        // LucideアイコンをSVGコンポーネントとして定義
        const IconBase = ({ size = 24, fill = "none", stroke = "currentColor", strokeWidth = 2, className = "", ...props }) => (
            <svg
                xmlns="http://www.w3.org/2000/svg"
                width={size}
                height={size}
                viewBox="0 0 24 24"
                fill={fill}
                stroke={stroke}
                strokeWidth={strokeWidth}
                strokeLinecap="round"
                strokeLinejoin="round"
                className={className}
                {...props}
            />
        );

        const Crown = (props) => <IconBase {...props}><path d="m2 4 3 12h14l3-12-6 7-4-7-4 7-6-7zm3 16h14" /></IconBase>;
        const Shield = (props) => <IconBase {...props}><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10" /></IconBase>;
        const Skull = (props) => <IconBase {...props}><path d="m12.5 17-.5-1-.5 1h1z"/><path d="M15 22a1 1 0 0 0 1-1v-1a2 2 0 0 0 1.56-3.25 8 8 0 1 0-11.12 0A2 2 0 0 0 8 20v1a1 1 0 0 0 1 1z"/><circle cx="15" cy="12" r="1"/><circle cx="9" cy="12" r="1"/></IconBase>;
        const Eye = (props) => <IconBase {...props}><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/></IconBase>;
        const BookOpen = (props) => <IconBase {...props}><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></IconBase>;
        const Coins = (props) => <IconBase {...props}><circle cx="8" cy="8" r="6"/><path d="M18.09 10.37A6 6 0 1 1 10.34 18"/><path d="M7 6h1v4"/><path d="m16.71 13.88.7.71-2.82 2.82"/></IconBase>;
        const Undo2 = (props) => <IconBase {...props}><path d="M9 14 4 9l5-5"/><path d="M4 9h10.5a5.5 5.5 0 0 1 5.5 5.5v0a5.5 5.5 0 0 1-5.5 5.5H11"/></IconBase>;
        const Play = (props) => <IconBase {...props}><polygon points="5 3 19 12 5 21 5 3"/></IconBase>;
        const X = (props) => <IconBase {...props}><path d="M18 6 6 18"/><path d="m6 6 12 12"/></IconBase>;
        const User = (props) => <IconBase {...props}><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></IconBase>;
        const AlertTriangle = (props) => <IconBase {...props}><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></IconBase>;

        // カスタムアイコン
        function DoorIcon(props) {
            return <IconBase {...props}><path d="M13 4h3a2 2 0 0 1 2 2v14" /><path d="M2 20h3" /><path d="M13 20h9" /><path d="M10 12v.01" /><path d="M13 4.562v16.157a1 1 0 0 1-1.242.97L5 20V5.562a2 2 0 0 1 1.515-1.94l4-1A2 2 0 0 1 13 4.561Z" /></IconBase>;
        }
        function SwordsIcon(props) {
            return <IconBase {...props}><polyline points="14.5 17.5 3 6 3 3 6 3 17.5 14.5" /><line x1="13" y1="19" x2="19" y2="13" /><line x1="16" y1="16" x2="20" y2="20" /><line x1="19" y1="21" x2="21" y2="19" /></IconBase>;
        }
        function GhostIcon(props) {
            return <IconBase {...props}><path d="M9 10h.01" /><path d="M15 10h.01" /><path d="M12 2a8 8 0 0 0-8 8v12l3-3 2.5 2.5L12 19l2.5 2.5L17 19l3 3V10a8 8 0 0 0-8-8z" /></IconBase>;
        }

        // --- Main Component ---
        function App() {
            // 初期プレイヤーデータ（4人分）
            const initialPlayers = [
                { id: 1, name: 'P1', color: 'bg-blue-600', ring: 'ring-blue-300', roomId: null, history: [] },
                { id: 2, name: 'P2', color: 'bg-red-600', ring: 'ring-red-300', roomId: null, history: [] },
                { id: 3, name: 'P3', color: 'bg-emerald-600', ring: 'ring-emerald-300', roomId: null, history: [] },
                { id: 4, name: 'P4', color: 'bg-amber-500', ring: 'ring-amber-300', roomId: null, history: [] },
            ];

            const [players, setPlayers] = useState(initialPlayers);
            const [activePlayerId, setActivePlayerId] = useState(1);
            const [initiativeHolderId, setInitiativeHolderId] = useState(null); 
            const [selectedRoomId, setSelectedRoomId] = useState(null); 
            const [showResetConfirm, setShowResetConfirm] = useState(false); // リセット確認モーダル用

            // 地下街データ構造
            const rooms = [
                // Level 1
                {
                id: 'entrance',
                level: 1,
                name: '秘密の入り口',
                effect: '基本土地を探す',
                detail: 'あなたのライブラリーから基本土地・カード１枚を探し、公開し、あなたの手札に加える。その後、ライブラリーを切り直す。',
                next: ['forge', 'lost_well'],
                icon: <DoorIcon />,
                bg: 'bg-stone-800',
                accent: 'text-emerald-400',
                border: 'border-stone-600'
                },
                // Level 2
                {
                id: 'forge',
                level: 2,
                name: '鍛冶場',
                effect: '+1/+1カウンター２個',
                detail: 'クリーチャー１体を対象とする。それの上に＋１/＋１カウンター２個を置く。',
                next: ['trap', 'arena'],
                icon: <Shield size={18} />,
                bg: 'bg-stone-800',
                accent: 'text-red-400',
                border: 'border-stone-600'
                },
                {
                id: 'lost_well',
                level: 2,
                name: '失われた井戸',
                effect: '占術２',
                detail: '占術２を行う。',
                next: ['arena', 'stash'],
                icon: <Eye size={18} />,
                bg: 'bg-stone-800',
                accent: 'text-blue-400',
                border: 'border-stone-600'
                },
                // Level 3
                {
                id: 'trap',
                level: 3,
                name: '罠だ！',
                effect: '対象は５点ライフを失う',
                detail: 'プレイヤー１人を対象とする。そのプレイヤーは５点のライフを失う。',
                next: ['archives'],
                icon: <Skull size={18} />,
                bg: 'bg-stone-800',
                accent: 'text-purple-400',
                border: 'border-stone-600'
                },
                {
                id: 'arena',
                level: 3,
                name: '闘技場',
                effect: 'クリーチャー１体を使嗾',
                detail: 'クリーチャー１体を対象とする。次のあなたのターンまで、それを使嗾する。',
                next: ['archives', 'catacombs'],
                icon: <SwordsIcon />,
                bg: 'bg-stone-800',
                accent: 'text-orange-400',
                border: 'border-stone-600'
                },
                {
                id: 'stash',
                level: 3, 
                name: '隠し部屋',
                effect: '宝物を生成',
                detail: '宝物・トークン１つを生成する。',
                next: ['catacombs'],
                icon: <Coins size={18} />,
                bg: 'bg-stone-800',
                accent: 'text-yellow-400',
                border: 'border-stone-600'
                },
                // Level 4
                {
                id: 'archives',
                level: 4,
                name: '書庫', 
                effect: '１枚引く',
                detail: 'カード１枚を引く。',
                next: ['throne'],
                icon: <BookOpen size={18} />,
                bg: 'bg-stone-800',
                accent: 'text-blue-300',
                border: 'border-stone-600'
                },
                {
                id: 'catacombs',
                level: 4, 
                name: '地下墓地',
                effect: '4/1 威迫を生成',
                detail: '黒の4/1のスケルトン・クリーチャー・トークン１体を生成する。それは威迫を持つ。',
                next: ['throne'],
                icon: <GhostIcon />,
                bg: 'bg-stone-800',
                accent: 'text-stone-400',
                border: 'border-stone-600'
                },
                // Level 5
                {
                id: 'throne',
                level: 5, 
                name: '死せる三者の玉座',
                effect: 'トップ10枚からクリーチャー',
                detail: 'あなたのライブラリーの一番上にあるカード10枚を公開する。あなたはその中からクリーチャー・カード１枚を＋１/＋１カウンター３個を置いた状態で戦場に出してもよい。それはターン終了時まで呪禁を得る。その後、ライブラリーを切り直す。',
                next: [], 
                icon: <Crown size={18} />,
                bg: 'bg-stone-800',
                accent: 'text-amber-400',
                border: 'border-amber-600'
                }
            ];

            const getRoom = (id) => rooms.find(r => r.id === id);
            const activePlayer = players.find(p => p.id === activePlayerId);
            const currentRoomId = activePlayer.roomId;
            const viewingRoom = getRoom(selectedRoomId);

            const isReachable = (targetRoomId) => {
                if (!currentRoomId) return targetRoomId === 'entrance';
                if (currentRoomId === 'throne') return targetRoomId === 'entrance';
                const current = getRoom(currentRoomId);
                return current?.next.includes(targetRoomId);
            };

            const handleRoomSelect = (roomId) => {
                setSelectedRoomId(roomId);
            };

            const handleMove = () => {
                if (!selectedRoomId) return;
                
                setPlayers(prev => prev.map(p => {
                if (p.id === activePlayerId) {
                    const newHistory = [...p.history, p.roomId];
                    return { ...p, roomId: selectedRoomId, history: newHistory };
                }
                return p;
                }));
                setInitiativeHolderId(activePlayerId);
                setSelectedRoomId(null);
            };

            const handleUndo = () => {
                setPlayers(prev => prev.map(p => {
                if (p.id === activePlayerId && p.history.length > 0) {
                    const prevRoom = p.history[p.history.length - 1];
                    const newHistory = p.history.slice(0, -1);
                    return { ...p, roomId: prevRoom, history: newHistory };
                }
                return p;
                }));
                setSelectedRoomId(null);
            };

            const handleResetClick = () => {
                setShowResetConfirm(true);
            };

            const executeReset = () => {
                setPlayers(initialPlayers);
                setActivePlayerId(1);
                setInitiativeHolderId(null);
                setSelectedRoomId(null);
                setShowResetConfirm(false);
            };

            const toggleInitiative = (e, playerId) => {
                e.stopPropagation();
                setInitiativeHolderId(current => current === playerId ? null : playerId);
            };

            const canMoveToSelected = selectedRoomId && isReachable(selectedRoomId);
            const isCurrentLoc = selectedRoomId === currentRoomId;

            return (
                <div className="min-h-screen bg-[#1c1917] text-stone-300 font-sans flex flex-col selection:bg-amber-900 selection:text-white">
                
                {/* Header */}
                <header className="bg-[#292524] border-b-2 border-[#44403c] px-4 py-2 flex justify-between items-center sticky top-0 z-40 shadow-xl h-14 shrink-0">
                    <div className="flex items-center gap-2">
                    <h1 className="font-bold text-lg text-stone-200 tracking-wider flex items-center gap-2" style={{ textShadow: '2px 2px 0px #000' }}>
                        <span className="text-amber-600">❖</span>
                        地下街探索
                    </h1>
                    </div>
                    <div className="flex items-center gap-2">
                        <button
                            onClick={handleUndo}
                            disabled={activePlayer.history.length === 0}
                            className={`p-2 rounded bg-[#1c1917] border border-stone-600 shadow-inner transition-all ${activePlayer.history.length > 0 ? 'text-stone-300 hover:text-white hover:border-stone-400' : 'opacity-30 text-stone-600 cursor-not-allowed'}`}
                            title="Undo"
                        >
                            <Undo2 size={16} />
                        </button>
                        <button 
                        onClick={handleResetClick}
                        className="text-xs font-bold text-stone-400 hover:text-red-400 px-3 py-2 rounded bg-[#1c1917] border border-stone-600 hover:border-red-900 shadow-inner transition-colors"
                        >
                        RESET
                        </button>
                    </div>
                </header>

                {/* Main Map Area */}
                <main className="flex-grow p-2 pb-24 overflow-y-auto">
                    <div className="fixed inset-0 pointer-events-none opacity-20 bg-[radial-gradient(circle_at_center,_var(--tw-gradient-stops))] from-stone-800 via-[#1c1917] to-black" />
                    
                    <div className="relative py-4 select-none max-w-lg mx-auto">
                    
                    <RoomRow>
                        <RoomNode room={getRoom('entrance')} {...nodeProps('entrance')} widthClass="w-[90vw] max-w-[330px]" />
                    </RoomRow>

                    <PathConnector type="split" />

                    <RoomRow>
                        <RoomNode room={getRoom('forge')} {...nodeProps('forge')} />
                        <RoomNode room={getRoom('lost_well')} {...nodeProps('lost_well')} />
                    </RoomRow>

                    <PathConnector type="complex_2_3" />

                    <RoomRow>
                        <RoomNode room={getRoom('trap')} {...nodeProps('trap')} widthClass="w-[28vw] max-w-[100px]" />
                        <RoomNode room={getRoom('arena')} {...nodeProps('arena')} widthClass="w-[32vw] max-w-[120px]" />
                        <RoomNode room={getRoom('stash')} {...nodeProps('stash')} widthClass="w-[28vw] max-w-[100px]" />
                    </RoomRow>

                    <PathConnector type="complex_3_2" />

                    <RoomRow>
                        <RoomNode room={getRoom('archives')} {...nodeProps('archives')} />
                        <RoomNode room={getRoom('catacombs')} {...nodeProps('catacombs')} />
                    </RoomRow>

                    <PathConnector type="merge" />

                    <RoomRow>
                        <RoomNode room={getRoom('throne')} {...nodeProps('throne')} widthClass="w-[90vw] max-w-[330px]" />
                    </RoomRow>
                    
                    <div className="h-20"></div>
                    </div>
                </main>

                {/* Room Detail Modal */}
                {selectedRoomId && viewingRoom && (
                    <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm animate-in fade-in duration-300">
                        <div 
                            className={`w-full max-w-sm rounded-lg shadow-[0_0_50px_rgba(0,0,0,0.8)] border-4 border-[#44403c] bg-[#292524] overflow-hidden transform transition-all scale-100 relative`}
                            onClick={(e) => e.stopPropagation()}
                        >
                            <div className={`absolute inset-0 pointer-events-none opacity-10 bg-gradient-to-br from-white/10 to-black/50`} />

                            <div className="flex justify-between items-start p-5 bg-[#1c1917] border-b border-[#44403c]">
                                <div className="flex items-center gap-4">
                                    <div className={`p-3 rounded bg-[#0c0a09] shadow-[inset_0_2px_4px_rgba(0,0,0,0.6)] ${viewingRoom.accent}`}>
                                        {React.cloneElement(viewingRoom.icon, { size: 28 })}
                                    </div>
                                    <div>
                                        <h2 className="text-xl font-black text-stone-100 tracking-wide uppercase" style={{ textShadow: '2px 2px 0px #000' }}>
                                            {viewingRoom.name}
                                        </h2>
                                        <div className="flex gap-2 mt-1.5">
                                            <span className="text-[10px] font-bold bg-[#44403c] text-stone-300 px-2 py-0.5 rounded border border-stone-600">
                                                LV. {viewingRoom.level}
                                            </span>
                                            {isCurrentLoc && (
                                                <span className="text-[10px] font-bold bg-emerald-900/50 text-emerald-400 px-2 py-0.5 rounded border border-emerald-700 flex items-center gap-1 shadow-[0_0_10px_rgba(16,185,129,0.2)]">
                                                    <Play size={8} fill="currentColor" /> 現在地
                                                </span>
                                            )}
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div className="p-6 bg-[#292524]">
                                <div className="bg-[#1c1917] p-4 rounded border border-[#44403c] shadow-inner">
                                    <p className="text-base font-serif text-stone-300 leading-relaxed min-h-[5rem]">
                                        {viewingRoom.detail}
                                    </p>
                                </div>
                            </div>

                            <div className="p-4 bg-[#1c1917] flex gap-3 border-t border-[#44403c]">
                                <button
                                    onClick={() => setSelectedRoomId(null)}
                                    className="flex-1 py-3 px-4 rounded font-bold text-stone-400 hover:text-stone-200 bg-[#292524] hover:bg-[#44403c] border border-stone-700 transition-colors uppercase tracking-wider"
                                >
                                    Close
                                </button>
                                {!isCurrentLoc && (
                                    <button
                                        onClick={handleMove}
                                        disabled={!canMoveToSelected}
                                        className={`
                                            flex-[2] py-3 px-4 rounded font-bold shadow-lg flex items-center justify-center gap-2 transition-all uppercase tracking-wider border
                                            ${canMoveToSelected
                                                ? 'bg-gradient-to-t from-stone-800 to-stone-700 border-stone-500 text-emerald-400 hover:text-emerald-300 hover:border-emerald-500 shadow-[0_0_15px_rgba(16,185,129,0.15)] active:scale-[0.98]'
                                                : 'bg-[#0c0a09] border-[#292524] text-stone-600 cursor-not-allowed'}
                                        `}
                                    >
                                        {canMoveToSelected ? (
                                            <>
                                                <span>Enter</span>
                                                <Play size={16} fill="currentColor" />
                                            </>
                                        ) : (
                                            <span className="text-xs">Unreachable</span>
                                        )}
                                    </button>
                                )}
                            </div>
                        </div>
                    </div>
                )}

                {/* Reset Confirmation Modal */}
                {showResetConfirm && (
                    <div className="fixed inset-0 z-[60] flex items-center justify-center p-4 bg-black/90 backdrop-blur-md animate-in fade-in duration-200">
                        <div 
                            className={`w-full max-w-sm rounded-lg shadow-[0_0_50px_rgba(255,0,0,0.2)] border-4 border-red-900 bg-[#1a0505] overflow-hidden transform transition-all scale-100 relative`}
                            onClick={(e) => e.stopPropagation()}
                        >
                            <div className="p-6 text-center">
                                <div className="mx-auto w-16 h-16 bg-red-900/30 rounded-full flex items-center justify-center mb-4 border border-red-800">
                                    <AlertTriangle size={32} className="text-red-500" />
                                </div>
                                <h2 className="text-xl font-black text-red-100 uppercase tracking-widest mb-2">Warning</h2>
                                <p className="text-stone-400 text-sm mb-6">
                                    全員の探索状況をリセットしますか？<br/>
                                    この操作は取り消せません。
                                </p>
                                
                                <div className="flex gap-3">
                                    <button
                                        onClick={() => setShowResetConfirm(false)}
                                        className="flex-1 py-3 px-4 rounded font-bold text-stone-400 hover:text-stone-200 bg-[#292524] hover:bg-[#44403c] border border-stone-700 transition-colors uppercase tracking-wider"
                                    >
                                        Cancel
                                    </button>
                                    <button
                                        onClick={executeReset}
                                        className="flex-1 py-3 px-4 rounded font-bold text-red-100 hover:text-white bg-red-900 hover:bg-red-800 border border-red-700 transition-colors uppercase tracking-wider shadow-lg"
                                    >
                                        Reset
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                )}

                {/* 4. Player Selector (Gem Style) */}
                <div className="fixed bottom-0 left-0 right-0 z-50 bg-[#1c1917] border-t-[6px] border-[#292524] pb-safe-area shadow-[0_-10px_40px_rgba(0,0,0,0.8)]">
                    <div className="flex justify-between px-2 py-4 gap-1 max-w-lg mx-auto w-full">
                    {players.map(p => {
                        const isInitiativeHolder = initiativeHolderId === p.id;
                        const isActive = activePlayerId === p.id;
                        
                        return (
                            <button
                            key={p.id}
                            onClick={() => {
                                setActivePlayerId(p.id);
                            }}
                            className={`
                                relative flex-1 flex flex-col justify-center items-center py-2 px-0.5 rounded-md transition-all duration-300
                                overflow-visible
                                ${isActive 
                                    ? 'z-10' 
                                    : 'opacity-70 hover:opacity-100 z-0 grayscale-[0.3] hover:grayscale-0'}
                            `}
                            >
                            
                            {/* 宝石の台座 */}
                            <div className={`absolute inset-0 bg-[#44403c] rounded-md -z-10 shadow-xl ${isActive ? 'bg-[#78716c]' : ''}`} />
                            <div className={`absolute inset-[2px] bg-[#1c1917] rounded-sm -z-10`} />

                            {/* 宝石本体 */}
                            <div className={`absolute inset-[4px] rounded-sm overflow-hidden border border-black/50 shadow-inner`}>
                                <div className={`absolute inset-0 ${p.color} opacity-80`} />
                                <div className="absolute inset-0 bg-gradient-to-br from-white/30 via-transparent to-black/80" />
                                <div className="absolute top-0 left-0 right-0 h-[45%] bg-gradient-to-b from-white/20 to-transparent" />
                                {isActive && (
                                    <div className={`absolute inset-0 animate-pulse ${p.color} mix-blend-screen opacity-60`} />
                                )}
                            </div>

                            {/* 外部発光 */}
                            {isActive && (
                                <div className={`absolute -inset-1 ${p.color} opacity-30 blur-lg -z-20`} />
                            )}
                            
                            {/* Initiative Crown */}
                            <div 
                                onClick={(e) => toggleInitiative(e, p.id)}
                                className={`
                                    absolute -top-5 -right-2 z-50 transition-all cursor-pointer transform duration-500 ease-out
                                    ${isInitiativeHolder ? 'scale-110 opacity-100 translate-y-0' : 'scale-0 opacity-0 translate-y-4'}
                                `}
                            >
                                <div className="bg-black text-amber-400 p-1.5 rounded-full shadow-[0_0_15px_rgba(251,191,36,0.6)] border border-amber-500 ring-2 ring-black/50">
                                    <Crown size={14} fill="currentColor" />
                                </div>
                            </div>

                            {/* Ghost Crown */}
                            {isActive && !isInitiativeHolder && (
                                <div 
                                    onClick={(e) => toggleInitiative(e, p.id)}
                                    className="absolute -top-4 -right-2 z-50 opacity-20 hover:opacity-100 transition-opacity cursor-pointer"
                                >
                                    <div className="bg-black/50 text-white/50 p-1 rounded-full border border-white/20 backdrop-blur-sm">
                                        <Crown size={12} />
                                    </div>
                                </div>
                            )}
                            
                            {/* Name */}
                            <div className="relative z-10 w-full flex flex-col items-center justify-center pt-1 pb-1">
                                <span className={`text-lg font-medium tracking-tight drop-shadow-md ${isActive ? 'text-white' : 'text-white/80'}`} style={{ fontFamily: 'sans-serif', textShadow: '0 1px 2px rgba(0,0,0,0.8)' }}>
                                    {p.name}
                                </span>
                            </div>

                            </button>
                        )
                    })}
                    </div>
                </div>

                </div>
            );

            function nodeProps(id) {
                return {
                activePlayerId,
                players,
                isCurrent: activePlayer.roomId === id,
                isReachable: isReachable(id),
                onSelect: handleRoomSelect
                };
            }
        }

        // Sub-components
        function RoomRow({ children }) {
            return (
                <div className="flex justify-center gap-3 relative z-10 mb-2 w-full px-2">
                {children}
                </div>
            );
        }

        function RoomNode({ room, activePlayerId, players, isCurrent, isReachable, onSelect, widthClass }) {
            const playersHere = players.filter(p => p.roomId === room.id);

            let containerClass = "bg-[#292524] border-[#44403c] opacity-60";
            let iconClass = "text-stone-600";
            let textClass = "text-stone-500";
            
            if (isCurrent) {
                containerClass = `bg-[#1c1917] border-stone-400 shadow-[inset_0_0_20px_rgba(0,0,0,0.8)] opacity-100 ring-2 ring-offset-2 ring-offset-[#0c0a09] ring-stone-500`;
                iconClass = room.accent; 
                textClass = "text-white";
            } else if (isReachable) {
                containerClass = "bg-[#292524] border-stone-500 opacity-100 cursor-pointer hover:bg-[#44403c] hover:border-stone-400";
                iconClass = "text-stone-400";
                textClass = "text-stone-300";
            } 

            const width = widthClass || "w-[45vw] max-w-[160px]";

            return (
                <button
                onClick={() => onSelect(room.id)}
                className={`
                    relative flex flex-col items-center justify-center py-3 px-1 rounded-sm border-[3px] transition-all duration-200
                    ${width} min-h-[64px]
                    ${containerClass}
                    active:scale-[0.98]
                    group
                `}
                style={{
                    boxShadow: isCurrent ? '0 0 15px rgba(0,0,0,0.8)' : '0 4px 0 rgba(0,0,0,0.5)'
                }}
                >
                {playersHere.length > 0 && (
                    <div className="absolute -top-3 left-1/2 -translate-x-1/2 flex -space-x-2 z-30 filter">
                        {playersHere.map((p) => (
                            <div 
                                key={p.id} 
                                className={`
                                    w-7 h-7 rounded rotate-45 ${p.color} border-2 border-[#1c1917] flex items-center justify-center shadow-lg
                                    transition-transform
                                    ${p.id === activePlayerId ? 'scale-110 z-20 ring-2 ring-white/50' : 'z-10 opacity-90'}
                                `}
                                style={{ transform: p.id === activePlayerId ? 'translateY(-4px) rotate(45deg)' : 'rotate(45deg)' }}
                            >
                                <span className="-rotate-45 text-white font-black text-[10px] drop-shadow-md">{p.name}</span>
                            </div>
                        ))}
                    </div>
                )}

                <div className={`relative z-10 p-1.5 rounded bg-[#0c0a09]/50 ${iconClass} transition-colors border border-white/5`}>
                    {React.cloneElement(room.icon, { size: 22 })}
                </div>
                
                <div className={`relative z-10 text-xs sm:text-sm font-bold text-center leading-tight px-1 mt-1 uppercase tracking-tight ${textClass}`} style={{ textShadow: isCurrent ? '0 0 10px currentColor' : 'none' }}>
                    {room.name}
                </div>

                </button>
            );
        }

        // Path Connector
        function PathConnector({ type }) {
            const strokeColor = "text-[#57534e]"; 
            const strokeWidth = "3";
            const heightClass = "h-6"; 

            const PathLine = (props) => (
                <line {...props} stroke="currentColor" strokeWidth={strokeWidth} className={`${strokeColor} drop-shadow-md`} strokeLinecap="square" />
            );
            const PathDraw = (props) => (
                <path {...props} fill="none" stroke="currentColor" strokeWidth={strokeWidth} className={`${strokeColor} drop-shadow-md`} strokeLinecap="square" />
            );

            if (type === 'split') { 
                return (
                <div className={`${heightClass} w-full flex justify-center items-center relative -my-1 opacity-60 pointer-events-none`}>
                    <svg width="100%" height="100%" viewBox="0 0 200 32" preserveAspectRatio="none">
                    <PathLine x1="100" y1="0" x2="100" y2="16" />
                    <PathLine x1="50" y1="16" x2="150" y2="16" />
                    <PathLine x1="50" y1="16" x2="50" y2="32" />
                    <PathLine x1="150" y1="16" x2="150" y2="32" />
                    </svg>
                </div>
                );
            }
            if (type === 'complex_2_3') {
                return (
                <div className={`${heightClass} w-full flex justify-center items-center relative -my-1 opacity-60 pointer-events-none`}>
                    <svg width="100%" height="100%" viewBox="0 0 200 32" preserveAspectRatio="none">
                        <PathDraw d="M50 0 L50 16 L33 16 L33 32" />
                        <PathDraw d="M50 16 L100 16 L100 32" />
                        <PathDraw d="M150 0 L150 16 L100 16" />
                        <PathDraw d="M150 16 L166 16 L166 32" />
                    </svg>
                </div>
                );
            }
            if (type === 'complex_3_2') { 
                return (
                <div className={`${heightClass} w-full flex justify-center items-center relative -my-1 opacity-60 pointer-events-none`}>
                    <svg width="100%" height="100%" viewBox="0 0 200 32" preserveAspectRatio="none">
                        <PathDraw d="M33 0 L33 16 L50 16 L50 32" />
                        <PathDraw d="M100 0 L100 16 L50 16" />
                        <PathDraw d="M100 16 L150 16 L150 32" />
                        <PathDraw d="M166 0 L166 16 L150 16" />
                    </svg>
                </div>
                );
            }
            if (type === 'merge') {
                return (
                <div className={`${heightClass} w-full flex justify-center items-center relative -my-1 opacity-60 pointer-events-none`}>
                    <svg width="100%" height="100%" viewBox="0 0 200 32" preserveAspectRatio="none">
                    <PathDraw d="M50 0 L50 16 L100 16 L100 32" />
                    <PathDraw d="M150 0 L150 16 L100 16" />
                    </svg>
                </div>
                );
            }
            return null;
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
