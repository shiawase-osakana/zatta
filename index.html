<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>EDH Life Counter (Unified)</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Config & Styles -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        p1: '#00f0ff', // Cyan
                        p2: '#ff2a6d', // Neon Red
                        p3: '#05f966', // Neon Green
                        p4: '#d300ff', // Neon Purple
                        dark: '#050505',
                        panel: '#121212',
                    },
                    fontFamily: {
                        sans: ['"Hiragino Sans"', '"Hiragino Kaku Gothic ProN"', '"Noto Sans JP"', 'sans-serif'],
                        mono: ['ui-monospace', 'SFMono-Regular', 'Menlo', 'Monaco', 'Consolas', monospace],
                    },
                    animation: {
                        'pulse-fast': 'pulse 1s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'pop': 'pop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275)',
                        'slide-in': 'slideIn 0.2s ease-out forwards',
                    },
                    keyframes: {
                        pop: {
                            '0%': { transform: 'scale(0.9)', opacity: '0' },
                            '100%': { transform: 'scale(1)', opacity: '1' },
                        },
                        slideIn: {
                            '0%': { opacity: '0', transform: 'translateY(-10px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        }
                    },
                    fontSize: {
                        'life-huge': '28vmin', 
                    },
                }
            }
        }
    </script>
    <style>
        body {
            overscroll-behavior: none;
            touch-action: none;
            user-select: none;
            -webkit-user-select: none;
            -webkit-touch-callout: none;
            font-family: "Hiragino Sans", "Hiragino Kaku Gothic ProN", "Noto Sans JP", sans-serif;
            background-color: #050505;
            color: white;
            overflow: hidden;
            margin: 0;
            padding: 0;
            width: 100vw;
            height: 100vh;
        }
        
        .tabular-nums { font-variant-numeric: tabular-nums; }

        .game-board-container {
            width: 100vw;
            height: 100vh;
            position: absolute;
            top: 0;
            left: 0;
        }
        @media screen and (orientation: portrait) {
            .game-board-container {
                transform: rotate(90deg);
                transform-origin: center;
                width: 100vh;
                height: 100vw;
                top: 50%;
                left: 50%;
                margin-left: -50vh;
                margin-top: -50vw;
            }
        }

        ::-webkit-scrollbar { display: none; }
        .neon-line { filter: drop-shadow(0 0 8px var(--glow-color)); }

        .glass-panel {
            background: rgba(18, 18, 18, 0.9);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.5);
        }
        
        .hud-grid-bg {
            background-image: 
                linear-gradient(rgba(255, 255, 255, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255, 255, 255, 0.03) 1px, transparent 1px);
            background-size: 20px 20px;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useRef, useEffect } = React;

        // --- Icons (SVG) ---
        const SkullIcon = ({ className }) => (
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                <circle cx="9" cy="12" r="1" />
                <circle cx="15" cy="12" r="1" />
                <path d="M8 20v2h8v-2" />
                <path d="M12.5 17l-.5-1-.5 1h1z" />
                <path d="M16 20a2 2 0 0 0 1.56-3.25 8 8 0 1 0-11.12 0A2 2 0 0 0 8 20" />
            </svg>
        );

        const SwordIcon = ({ className }) => (
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                <polyline points="14.5 17.5 3 6 3 3 6 3 17.5 14.5" />
                <line x1="13" y1="19" x2="19" y2="13" />
                <line x1="16" y1="16" x2="20" y2="20" />
                <line x1="19" y1="21" x2="21" y2="19" />
            </svg>
        );

        const ShieldIcon = ({ className }) => (
             <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z" />
            </svg>
        );

        const BoltIcon = ({ className }) => (
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2" />
            </svg>
        );

        const CrownIcon = ({ className }) => (
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                <path d="M2 4l3 12h14l3-12-6 7-4-7-4 7-6-7zm3 16h14" />
            </svg>
        );

        // --- Configuration ---
        const PLAYERS_CONFIG = [
            { id: 0, label: 'P1', hex: '#00f0ff', rotate: true },
            { id: 1, label: 'P2', hex: '#ff2a6d', rotate: true },
            { id: 2, label: 'P3', hex: '#05f966', rotate: false },
            { id: 3, label: 'P4', hex: '#d300ff', rotate: false },
        ];

        const INITIAL_LIFE = 40;
        const LETHAL_COMMANDER_DAMAGE = 21;

        // --- Animated Counter Component ---
        const AnimatedCounter = ({ value, className, style }) => {
            const [displayValue, setDisplayValue] = useState(value);
            const startTimeRef = useRef(null);
            const startValueRef = useRef(value);
            const targetValueRef = useRef(value);
            const frameRef = useRef(null);

            useEffect(() => {
                if (value !== targetValueRef.current) {
                    startValueRef.current = displayValue;
                    targetValueRef.current = value;
                    startTimeRef.current = null;

                    const animate = (timestamp) => {
                        if (!startTimeRef.current) startTimeRef.current = timestamp;
                        const progress = timestamp - startTimeRef.current;
                        const duration = 600; 

                        if (progress < duration) {
                            const rate = 1 - Math.pow(1 - progress / duration, 3);
                            const nextValue = startValueRef.current + (targetValueRef.current - startValueRef.current) * rate;
                            setDisplayValue(Math.round(nextValue));
                            frameRef.current = requestAnimationFrame(animate);
                        } else {
                            setDisplayValue(targetValueRef.current);
                        }
                    };
                    
                    if (frameRef.current) cancelAnimationFrame(frameRef.current);
                    frameRef.current = requestAnimationFrame(animate);
                }
            }, [value]);

            useEffect(() => {
                return () => {
                    if (frameRef.current) cancelAnimationFrame(frameRef.current);
                }
            }, []);

            return (
                <div className={className} style={style}>
                    {displayValue}
                </div>
            );
        };

        // --- HUD Jog Dial ---
        const HudJogDial = ({ value, onChange, color, label = "ダメージ量" }) => {
            const knobRef = useRef(null);
            const [angle, setAngle] = useState(0);
            const lastAngleRef = useRef(null);
            const accumRef = useRef(0);

            const handleStart = (e) => {
                e.preventDefault();
                const touch = e.touches[0];
                const rect = knobRef.current.getBoundingClientRect();
                const centerX = rect.left + rect.width / 2;
                const centerY = rect.top + rect.height / 2;
                lastAngleRef.current = Math.atan2(touch.clientY - centerY, touch.clientX - centerX);
            };

            const handleMove = (e) => {
                e.preventDefault();
                if (lastAngleRef.current === null) return;
                const touch = e.touches[0];
                const rect = knobRef.current.getBoundingClientRect();
                const centerX = rect.left + rect.width / 2;
                const centerY = rect.top + rect.height / 2;
                const currentAngle = Math.atan2(touch.clientY - centerY, touch.clientX - centerX);
                let delta = currentAngle - lastAngleRef.current;
                if (delta > Math.PI) delta -= 2 * Math.PI;
                if (delta < -Math.PI) delta += 2 * Math.PI;
                lastAngleRef.current = currentAngle;
                accumRef.current += delta;

                const threshold = 0.2;
                if (Math.abs(accumRef.current) >= threshold) {
                    const steps = Math.floor(Math.abs(accumRef.current) / threshold);
                    const sign = Math.sign(accumRef.current);
                    onChange(steps * sign);
                    accumRef.current -= (steps * threshold * sign);
                }
                setAngle(a => a + delta);
            };
            const handleEnd = () => { lastAngleRef.current = null; accumRef.current = 0; };

            return (
                <div className="relative w-full h-full flex items-center justify-center">
                    <div 
                        ref={knobRef}
                        className="relative w-40 h-40 lg:w-48 lg:h-48 rounded-full cursor-grab active:cursor-grabbing touch-none z-10"
                        onTouchStart={handleStart} onTouchMove={handleMove} onTouchEnd={handleEnd}
                    >
                        <div 
                            className="w-full h-full rounded-full border-2 border-white/10 bg-[#0a0a0a] shadow-[0_0_30px_rgba(0,0,0,0.8)] flex items-center justify-center transition-transform duration-75"
                            style={{ 
                                transform: `rotate(${angle}rad)`,
                                boxShadow: `inset 0 0 20px ${color}20, 0 0 20px rgba(0,0,0,0.5)`
                            }}
                        >
                            <div className="absolute top-0 left-1/2 -translate-x-1/2 w-1.5 h-4 bg-white rounded-full shadow-[0_0_10px_white]"></div>
                            {[...Array(12)].map((_,i) => (
                                <div key={i} className="absolute w-[2px] h-[6px] bg-gray-700 top-1 left-1/2 -ml-[1px]" style={{transformOrigin:'50% 50%', transform:`rotate(${i*30}deg) translateY(-85px)`}}></div>
                            ))}
                        </div>
                        <div className="absolute inset-0 flex flex-col items-center justify-center pointer-events-none">
                            <span className="text-6xl lg:text-7xl font-bold tabular-nums leading-none drop-shadow-[0_0_15px_rgba(255,255,255,0.3)]" style={{color: value < 0 ? '#ff5555' : 'white'}}>
                                {value > 0 && label === "ダメージ量" ? `+${value}` : value}
                            </span>
                            <span className="text-[10px] uppercase tracking-widest text-gray-500 mt-2 font-bold">{label}</span>
                        </div>
                    </div>
                </div>
            );
        };

        // --- Toggle Button ---
        const HudToggle = ({ label, active, onClick, color, icon: Icon, isCheckbox = false, isSmall = false }) => (
            <button 
                onClick={onClick}
                className={`
                    relative w-full ${isSmall ? 'py-2 px-3' : 'py-3 px-4'} rounded-lg border transition-all duration-200 flex items-center justify-between group overflow-hidden
                    ${active ? 'bg-white/5 border-white/30' : 'bg-transparent border-white/10 hover:bg-white/5'}
                `}
                style={{
                    borderColor: active ? color : undefined,
                    boxShadow: active ? `inset 0 0 10px ${color}10` : 'none'
                }}
            >
                <div className={`absolute left-0 top-0 bottom-0 w-0.5 transition-all duration-300 ${active ? 'opacity-100' : 'opacity-0'}`} style={{ backgroundColor: color }}></div>
                <div className="flex items-center gap-3 z-10 overflow-hidden">
                    <div className={`transition-colors flex-shrink-0 ${active ? 'text-white' : 'text-gray-500 group-hover:text-gray-300'}`} style={{ color: active ? color : undefined }}>
                        {Icon && <Icon className="w-5 h-5" />}
                    </div>
                    <span className={`${isSmall ? 'text-sm' : 'text-base'} font-bold tracking-wide whitespace-nowrap ${active ? 'text-white' : 'text-gray-400'}`}>{label}</span>
                </div>
                {isCheckbox && (
                    <div className={`w-5 h-5 rounded border flex-shrink-0 flex items-center justify-center transition-colors ${active ? 'border-transparent' : 'border-gray-600'}`} style={{ backgroundColor: active ? color : 'transparent' }}>
                        {active && <svg className="w-4 h-4 text-black" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="4"><path strokeLinecap="round" strokeLinejoin="round" d="M5 13l4 4L19 7" /></svg>}
                    </div>
                )}
            </button>
        );

        const App = () => {
            const [players, setPlayers] = useState(
                PLAYERS_CONFIG.map(p => ({
                    ...p, life: INITIAL_LIFE, commanderDamage: {}, castCount: { 0: 0, 1: 0 }, isPartnerMode: false,
                }))
            );

            const [dragState, setDragState] = useState({
                active: false, sourceId: null, startX: 0, startY: 0, currentX: 0, currentY: 0, targetId: null,
            });

            const [modalState, setModalState] = useState({
                open: false, sourceId: null, targetId: null, value: 0, isCommander: false, commanderIndex: 0, isLifelink: false, isDrain: false,
            });

            // New State for Unified Cast Count Modal
            const [cmdrModal, setCmdrModal] = useState({ 
                open: false, 
                playerId: null, 
                activeCommanderIndex: 0, // 0:A, 1:B (ダイヤル操作対象)
                tempValues: { 0: 0, 1: 0 } // モーダル内での一時的な値
            });

            const [resetModalOpen, setResetModalOpen] = useState(false);
            const playerRefs = useRef([]);
            const centerRef = useRef(null);

            // --- Logic ---
            const modifyLife = (targetId, amount) => {
                setPlayers(prev => prev.map(p => { if (p.id !== targetId) return p; return { ...p, life: p.life + amount }; }));
            };
            const togglePartnerMode = (targetId) => {
                setPlayers(prev => prev.map(p => { if (p.id !== targetId) return p; return { ...p, isPartnerMode: !p.isPartnerMode }; }));
            };
            
            // Cast Count Logic (Updated for Dial)
            const openCmdrModal = (playerId) => {
                const player = players[playerId];
                setCmdrModal({
                    open: true,
                    playerId: playerId,
                    activeCommanderIndex: 0,
                    // 現在のキャスト回数を「n回目（次の回数）」として表示するため +1 してセット
                    tempValues: { 
                        0: player.castCount[0] + 1, 
                        1: player.castCount[1] + 1 
                    }
                });
            };

            const commitCastCount = () => {
                const { playerId, tempValues } = cmdrModal;
                setPlayers(prev => prev.map(p => {
                    if (p.id !== playerId) return p;
                    return {
                        ...p,
                        castCount: {
                            // 表示値(n回目)から1引いて実数(n-1回唱えた)に戻す。最小0
                            0: Math.max(0, tempValues[0] - 1),
                            1: Math.max(0, tempValues[1] - 1)
                        }
                    };
                }));
                setCmdrModal({ ...cmdrModal, open: false });
            };

            const confirmReset = () => {
                setPlayers(PLAYERS_CONFIG.map(p => ({ ...p, life: INITIAL_LIFE, commanderDamage: {}, castCount: { 0: 0, 1: 0 }, isPartnerMode: false, })));
                setResetModalOpen(false);
            };
            const commitTransaction = () => {
                const { sourceId, targetId, value, isCommander, commanderIndex, isLifelink, isDrain } = modalState;
                if (value === 0) { setModalState({ ...modalState, open: false }); return; }
                setPlayers(prev => {
                    let nextPlayers = [...prev];
                    if (targetId === 'ALL') {
                        nextPlayers = nextPlayers.map(p => {
                            if (p.id === sourceId) return isDrain ? { ...p, life: p.life + value } : p;
                            else return { ...p, life: p.life - value };
                        });
                    } else {
                        nextPlayers = nextPlayers.map(p => {
                            if (p.id === sourceId) return isLifelink ? { ...p, life: p.life + value } : p;
                            if (p.id === targetId) {
                                let newP = { ...p, life: p.life - value };
                                if (isCommander) {
                                    const currentCD = p.commanderDamage[sourceId] || { 0: 0, 1: 0 };
                                    const newAmount = (currentCD[commanderIndex] || 0) + value;
                                    newP.commanderDamage = { ...p.commanderDamage, [sourceId]: { ...currentCD, [commanderIndex]: newAmount } };
                                }
                                return newP;
                            }
                            return p;
                        });
                    }
                    return nextPlayers;
                });
                setModalState({ ...modalState, open: false });
            };

            // --- Touch Handlers ---
            const handleTouchStart = (e, sourceId) => {
                if (e.target.closest('button') || e.target.closest('.pointer-events-auto')) return;
                const touch = e.touches[0];
                setDragState({ active: true, sourceId, startX: touch.clientX, startY: touch.clientY, currentX: touch.clientX, currentY: touch.clientY, targetId: null });
            };
            const handleTouchMove = (e) => {
                if (!dragState.active) return;
                const touch = e.touches[0];
                let foundTarget = null;
                playerRefs.current.forEach((ref, idx) => {
                    if (ref && idx !== dragState.sourceId) {
                        const rect = ref.getBoundingClientRect();
                        if (touch.clientX >= rect.left && touch.clientX <= rect.right && touch.clientY >= rect.top && touch.clientY <= rect.bottom) foundTarget = idx;
                    }
                });
                if (!foundTarget && centerRef.current) {
                    const rect = centerRef.current.getBoundingClientRect();
                    if (touch.clientX >= rect.left - 30 && touch.clientX <= rect.right + 30 && touch.clientY >= rect.top - 30 && touch.clientY <= rect.bottom + 30) foundTarget = 'ALL';
                }
                setDragState(prev => ({ ...prev, currentX: touch.clientX, currentY: touch.clientY, targetId: foundTarget }));
            };
            const handleTouchEnd = () => {
                if (!dragState.active) return;
                if (dragState.targetId !== null) {
                    setModalState({ open: true, sourceId: dragState.sourceId, targetId: dragState.targetId, value: 0, isCommander: false, commanderIndex: 0, isLifelink: false, isDrain: false });
                }
                setDragState(prev => ({ ...prev, active: false, targetId: null }));
            };

            const isDamageModalRotated = modalState.open && modalState.sourceId !== null ? PLAYERS_CONFIG[modalState.sourceId].rotate : false;
            const isCmdrModalRotated = cmdrModal.open && cmdrModal.playerId !== null ? PLAYERS_CONFIG[cmdrModal.playerId].rotate : false;

            return (
                <div className="fixed inset-0 bg-dark overflow-hidden" onTouchMove={handleTouchMove} onTouchEnd={handleTouchEnd}>
                    {/* Game Board */}
                    <div className="game-board-container flex flex-wrap relative z-10 p-1 gap-1 box-border">
                        {players.map((player, idx) => (
                            <div 
                                key={player.id} ref={el => playerRefs.current[idx] = el}
                                className={`
                                    relative flex-1 min-w-[45%] h-[calc(50%-0.25rem)] rounded-2xl flex flex-col justify-center transition-all duration-300 select-none bg-[#121212] border border-gray-800 overflow-hidden
                                    ${dragState.targetId === idx ? 'scale-[0.98] ring-4 ring-offset-2 ring-offset-black z-10' : ''} ${dragState.sourceId === idx ? 'opacity-90' : ''}
                                `}
                                style={{
                                    '--player-color': PLAYERS_CONFIG[idx].hex,
                                    boxShadow: `inset 0 0 30px -15px ${PLAYERS_CONFIG[idx].hex}`,
                                    borderColor: dragState.targetId === idx ? PLAYERS_CONFIG[idx].hex : 'rgba(255,255,255,0.08)'
                                }}
                                onTouchStart={(e) => handleTouchStart(e, player.id)}
                            >
                                <div className={`w-full h-full flex flex-col items-center relative pointer-events-none ${player.rotate ? 'rotate-180' : ''}`}>
                                    <div className="absolute inset-0 opacity-10" style={{ background: `radial-gradient(circle at center, ${PLAYERS_CONFIG[idx].hex}, transparent 80%)` }}></div>
                                    
                                    {/* --- 巨大ライフ表示 (アニメーション対応) --- */}
                                    <AnimatedCounter 
                                        value={player.life}
                                        className="absolute inset-0 flex items-center justify-center font-mono font-bold tabular-nums tracking-tighter leading-none z-0"
                                        style={{ 
                                            fontSize: '28vmin',
                                            textShadow: `0 0 50px ${PLAYERS_CONFIG[idx].hex}30`,
                                            color: player.life <= 0 ? '#333' : 'white'
                                        }}
                                    />

                                    {/* --- 前面レイヤー (UIパーツ) --- */}
                                    
                                    {/* 統率者ダメージバッジ (上部) */}
                                    <div className="absolute top-2 left-2 right-2 flex flex-wrap justify-center gap-1 z-20 min-h-[1.5rem]">
                                        {Object.entries(player.commanderDamage).map(([srcId, dmgs]) => (
                                            Object.entries(dmgs).map(([cmdrIdx, val]) => {
                                                if (val <= 0) return null;
                                                const isLethal = val >= LETHAL_COMMANDER_DAMAGE;
                                                return (
                                                    <span key={`${srcId}-${cmdrIdx}`} className={`text-xs font-bold px-2 py-0.5 rounded shadow-lg border flex items-center gap-1 backdrop-blur-md ${isLethal ? 'text-white border-red-500 bg-red-900/80 animate-pulse' : 'text-gray-200 border-gray-600 bg-black/60'}`}>
                                                        <span className="w-2 h-2 rounded-full shadow-[0_0_5px_currentColor]" style={{ backgroundColor: PLAYERS_CONFIG[srcId].hex, color: PLAYERS_CONFIG[srcId].hex }}></span>
                                                        {val} {isLethal && <SkullIcon className="w-3 h-3" />}
                                                    </span>
                                                );
                                            })
                                        ))}
                                    </div>

                                    {/* 操作ボタン (左右の端) - 視覚化済み */}
                                    <div className="absolute left-0 top-0 bottom-0 w-24 flex items-center justify-center z-30 pointer-events-none">
                                        <button 
                                            className="w-14 h-14 rounded-full border border-white/10 bg-black/40 backdrop-blur-md flex items-center justify-center pointer-events-auto active:scale-90 active:bg-white/10 active:border-white/40 transition-all duration-200 shadow-xl group"
                                            onTouchStart={(e) => { e.stopPropagation(); modifyLife(player.id, -1); }}
                                        >
                                            <span className="text-3xl text-white/50 group-active:text-white font-bold pb-1 transition-colors">−</span>
                                        </button>
                                    </div>
                                    <div className="absolute right-0 top-0 bottom-0 w-24 flex items-center justify-center z-30 pointer-events-none">
                                        <button 
                                            className="w-14 h-14 rounded-full border border-white/10 bg-black/40 backdrop-blur-md flex items-center justify-center pointer-events-auto active:scale-90 active:bg-white/10 active:border-white/40 transition-all duration-200 shadow-xl group"
                                            onTouchStart={(e) => { e.stopPropagation(); modifyLife(player.id, 1); }}
                                        >
                                            <span className="text-3xl text-white/50 group-active:text-white font-bold pb-1 transition-colors">＋</span>
                                        </button>
                                    </div>

                                    {/* キャスト回数 (下部中央) */}
                                    <div className="absolute bottom-4 left-0 right-0 flex justify-center z-20">
                                        <div 
                                            className="px-4 py-1.5 bg-black/20 border border-white/5 rounded-full text-xs font-bold text-gray-400 shadow-sm pointer-events-auto cursor-pointer active:scale-95 transition flex gap-2 tabular-nums backdrop-blur hover:bg-white/5 hover:text-white"
                                            onClick={(e) => { e.stopPropagation(); openCmdrModal(player.id); }}
                                        >
                                            {player.isPartnerMode ? (
                                                <>
                                                    <span style={{ color: PLAYERS_CONFIG[idx].hex }}>A:{player.castCount[0] + 1}</span>
                                                    <span className="opacity-30">|</span>
                                                    <span style={{ color: PLAYERS_CONFIG[idx].hex }}>B:{player.castCount[1] + 1}</span>
                                                </>
                                            ) : (
                                                <span>{player.castCount[0] + 1}回目 <span className="opacity-50">コスト+{player.castCount[0] * 2}</span></span>
                                            )}
                                        </div>
                                    </div>

                                </div>
                            </div>
                        ))}

                        {/* Center Zone */}
                        <div ref={centerRef} className={`absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[16vmin] h-[16vmin] rounded-full flex items-center justify-center transition-all duration-300 border shadow-[0_0_20px_rgba(0,0,0,0.5)] ${dragState.active ? (dragState.targetId === 'ALL' ? 'bg-yellow-500/20 border-yellow-400 scale-125 z-40 backdrop-blur-sm' : 'bg-black/80 border-white/20 scale-90 z-30 opacity-50') : 'bg-[#1a1a1a] border-[#333] z-50 hover:border-white/40'}`}>
                            {dragState.active ? <span className={`font-bold text-xs lg:text-sm text-center leading-tight ${dragState.targetId === 'ALL' ? 'text-yellow-400 drop-shadow-[0_0_5px_currentColor]' : 'text-gray-500'}`}>全員</span> : <button className="w-full h-full rounded-full flex items-center justify-center text-[10px] lg:text-xs font-bold text-gray-500 hover:text-white pointer-events-auto touch-manipulation tracking-widest" onClick={(e) => { e.stopPropagation(); setResetModalOpen(true); }}>リセット</button>}
                        </div>

                        {/* Modals */}
                        {resetModalOpen && (
                            <div className="absolute inset-0 z-[70] flex items-center justify-center bg-black/60 backdrop-blur-xl animate-pop">
                                <div className="bg-[#1a1a1a] border border-gray-700 rounded-2xl p-6 w-[320px] shadow-[0_0_50px_rgba(0,0,0,0.8)] flex flex-col items-center gap-4">
                                    <div className="text-xl font-bold text-white">ゲームリセット</div>
                                    <p className="text-gray-400 text-sm">初期状態に戻しますか？</p>
                                    <div className="flex w-full gap-3 mt-2">
                                        <button className="flex-1 py-3 bg-gray-800 rounded-lg font-bold text-gray-300 active:bg-gray-700 transition" onClick={() => setResetModalOpen(false)}>戻る</button>
                                        <button className="flex-1 py-3 bg-red-600/20 border border-red-500/50 text-red-400 rounded-lg font-bold active:bg-red-600/40 transition" onClick={confirmReset}>リセット</button>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* Damage Input Modal (Unified) */}
                        {modalState.open && (
                            <div className="absolute inset-0 z-[60] flex items-center justify-center bg-black/70 backdrop-blur-xl animate-pop">
                                <div className={`transition-transform duration-300 ${isDamageModalRotated ? 'rotate-180' : ''}`}>
                                    <div 
                                        className="glass-panel rounded-2xl overflow-hidden flex flex-row w-[95vw] max-w-[900px] h-auto max-h-[75vh] min-h-[320px] relative border"
                                        style={{ borderColor: `${PLAYERS_CONFIG[modalState.sourceId].hex}40` }}    
                                    >
                                        <div className="absolute inset-0 hud-grid-bg opacity-20 pointer-events-none"></div>
                                        
                                        {/* Left Panel: 50% */}
                                        <div className="w-[50%] flex flex-col border-r border-white/10 p-4 bg-[#0a0a0a]/80 z-10 relative">
                                            <div className="text-[10px] font-bold text-gray-500 mb-1 tracking-[0.2em]">ダメージ処理</div>
                                            <div className="flex items-center justify-between mb-4 pb-2 border-b border-white/10">
                                                <span className="font-bold text-base" style={{ color: PLAYERS_CONFIG[modalState.sourceId].hex }}>{PLAYERS_CONFIG[modalState.sourceId].label}</span>
                                                <span className="text-gray-600 text-[10px]">➞</span>
                                                <span className="font-bold text-base text-white">{modalState.targetId === 'ALL' ? '全員' : PLAYERS_CONFIG[modalState.targetId].label}</span>
                                            </div>

                                            <div className="flex-1 flex flex-col gap-3 overflow-y-auto">
                                                {modalState.targetId !== 'ALL' ? (
                                                    <>
                                                        <HudToggle 
                                                            label="統率者ダメージ" 
                                                            active={modalState.isCommander} 
                                                            onClick={() => {
                                                                const next = !modalState.isCommander;
                                                                setModalState(s => ({ ...s, isCommander: next, commanderIndex: next ? s.commanderIndex : 0 }));
                                                            }}
                                                            color="#ff2a6d"
                                                            icon={SwordIcon}
                                                            isCheckbox
                                                        />
                                                        {modalState.isCommander && (
                                                            <div className="pl-4 animate-slide-in">
                                                                <HudToggle 
                                                                    label="統率者B (共闘)" 
                                                                    active={modalState.commanderIndex === 1} 
                                                                    onClick={() => setModalState(s => ({ ...s, commanderIndex: s.commanderIndex === 1 ? 0 : 1 }))}
                                                                    color="#ff2a6d"
                                                                    isCheckbox
                                                                    isSmall
                                                                />
                                                            </div>
                                                        )}
                                                        <HudToggle 
                                                            label="絆魂 (回復)" 
                                                            active={modalState.isLifelink} 
                                                            onClick={() => setModalState(s => ({ ...s, isLifelink: !s.isLifelink }))}
                                                            color="#facc15"
                                                            icon={ShieldIcon}
                                                            isCheckbox
                                                        />
                                                    </>
                                                ) : (
                                                    <HudToggle 
                                                        label="ドレイン" 
                                                        active={modalState.isDrain} 
                                                        onClick={() => setModalState(s => ({ ...s, isDrain: !s.isDrain }))}
                                                        color="#d300ff"
                                                        icon={BoltIcon}
                                                        isCheckbox
                                                    />
                                                )}
                                            </div>

                                            <div className="mt-3 grid grid-cols-2 gap-2">
                                                <button className="h-10 rounded font-bold text-sm text-gray-400 bg-white/5 hover:bg-white/10 transition" onClick={() => setModalState({ ...modalState, open: false })}>キャンセル</button>
                                                <button 
                                                    className="h-10 rounded font-bold text-sm text-black shadow-lg hover:brightness-110 active:scale-95 transition" 
                                                    style={{ backgroundColor: PLAYERS_CONFIG[modalState.sourceId].hex }}
                                                    onClick={commitTransaction}
                                                >
                                                    決定
                                                </button>
                                            </div>
                                        </div>

                                        {/* Right Panel: Dial */}
                                        <div className="flex-1 relative flex items-center justify-center bg-gradient-to-br from-[#121212] to-[#050505]">
                                            <div className="absolute inset-0 opacity-10" style={{ background: `radial-gradient(circle at center, ${PLAYERS_CONFIG[modalState.sourceId].hex}, transparent 70%)` }}></div>
                                            <HudJogDial value={modalState.value} onChange={(delta) => setModalState(s => ({ ...s, value: s.value + delta }))} color={PLAYERS_CONFIG[modalState.sourceId].hex} />
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* Cast Count Modal (Unified HUD Design) */}
                        {cmdrModal.open && (
                            <div className="absolute inset-0 z-[60] flex items-center justify-center bg-black/70 backdrop-blur-xl animate-pop">
                                <div className={`transition-transform duration-300 ${isCmdrModalRotated ? 'rotate-180' : ''}`}>
                                    <div 
                                        className="glass-panel rounded-2xl overflow-hidden flex flex-row w-[95vw] max-w-[900px] h-auto max-h-[75vh] min-h-[320px] relative border"
                                        style={{ borderColor: `${PLAYERS_CONFIG[cmdrModal.playerId].hex}40` }}    
                                    >
                                        <div className="absolute inset-0 hud-grid-bg opacity-20 pointer-events-none"></div>
                                        
                                        {/* Left Panel */}
                                        <div className="w-[50%] flex flex-col border-r border-white/10 p-4 bg-[#0a0a0a]/80 z-10 relative">
                                            <div className="text-[10px] font-bold text-gray-500 mb-1 tracking-[0.2em]">キャスト回数設定</div>
                                            <div className="flex items-center justify-between mb-4 pb-2 border-b border-white/10">
                                                <span className="font-bold text-base" style={{ color: PLAYERS_CONFIG[cmdrModal.playerId].hex }}>{PLAYERS_CONFIG[cmdrModal.playerId].label}</span>
                                            </div>

                                            <div className="flex-1 flex flex-col gap-3 overflow-y-auto">
                                                {/* 共闘トグル */}
                                                <HudToggle 
                                                    label="共闘を使用する" 
                                                    active={players[cmdrModal.playerId].isPartnerMode} 
                                                    onClick={() => togglePartnerMode(cmdrModal.playerId)}
                                                    color="#3b82f6"
                                                    isCheckbox
                                                />

                                                <div className="border-t border-white/10 my-1"></div>

                                                {/* 統率者A選択 */}
                                                <HudToggle 
                                                    label="統率者A" 
                                                    active={cmdrModal.activeCommanderIndex === 0} 
                                                    onClick={() => setCmdrModal(s => ({ ...s, activeCommanderIndex: 0 }))}
                                                    color={PLAYERS_CONFIG[cmdrModal.playerId].hex}
                                                    icon={CrownIcon}
                                                />

                                                {/* 統率者B選択 (共闘時のみ) */}
                                                {players[cmdrModal.playerId].isPartnerMode && (
                                                    <HudToggle 
                                                        label="統率者B" 
                                                        active={cmdrModal.activeCommanderIndex === 1} 
                                                        onClick={() => setCmdrModal(s => ({ ...s, activeCommanderIndex: 1 }))}
                                                        color={PLAYERS_CONFIG[cmdrModal.playerId].hex}
                                                        icon={CrownIcon}
                                                    />
                                                )}
                                                
                                                {/* Current Cost Info */}
                                                <div className="mt-auto pt-2 text-center text-xs text-gray-500">
                                                    追加コスト: +{Math.max(0, cmdrModal.tempValues[cmdrModal.activeCommanderIndex] - 1) * 2}
                                                </div>
                                            </div>

                                            <div className="mt-3 grid grid-cols-2 gap-2">
                                                <button className="h-10 rounded font-bold text-sm text-gray-400 bg-white/5 hover:bg-white/10 transition" onClick={() => setCmdrModal({ ...cmdrModal, open: false })}>キャンセル</button>
                                                <button 
                                                    className="h-10 rounded font-bold text-sm text-black shadow-lg hover:brightness-110 active:scale-95 transition" 
                                                    style={{ backgroundColor: PLAYERS_CONFIG[cmdrModal.playerId].hex }}
                                                    onClick={commitCastCount}
                                                >
                                                    決定
                                                </button>
                                            </div>
                                        </div>

                                        {/* Right Panel: Dial */}
                                        <div className="flex-1 relative flex items-center justify-center bg-gradient-to-br from-[#121212] to-[#050505]">
                                            <div className="absolute inset-0 opacity-10" style={{ background: `radial-gradient(circle at center, ${PLAYERS_CONFIG[cmdrModal.playerId].hex}, transparent 70%)` }}></div>
                                            <HudJogDial 
                                                label="回目"
                                                value={cmdrModal.tempValues[cmdrModal.activeCommanderIndex]} 
                                                onChange={(delta) => {
                                                    const newVal = Math.max(1, cmdrModal.tempValues[cmdrModal.activeCommanderIndex] + delta);
                                                    setCmdrModal(s => ({
                                                        ...s,
                                                        tempValues: { ...s.tempValues, [s.activeCommanderIndex]: newVal }
                                                    }));
                                                }} 
                                                color={PLAYERS_CONFIG[cmdrModal.playerId].hex} 
                                            />
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>
                    {dragState.active && (
                        <svg className="absolute inset-0 pointer-events-none z-[55] w-full h-full overflow-visible" style={{ '--glow-color': PLAYERS_CONFIG[dragState.sourceId].hex }}>
                            <defs>
                                <filter id="glow" x="-50%" y="-50%" width="200%" height="200%">
                                    <feGaussianBlur stdDeviation="4" result="coloredBlur"/><feMerge><feMergeNode in="coloredBlur"/><feMergeNode in="SourceGraphic"/></feMerge>
                                </filter>
                            </defs>
                            <circle cx={dragState.startX} cy={dragState.startY} r="6" fill={PLAYERS_CONFIG[dragState.sourceId].hex} className="neon-line" />
                            <line x1={dragState.startX} y1={dragState.startY} x2={dragState.currentX} y2={dragState.currentY} stroke={PLAYERS_CONFIG[dragState.sourceId].hex} strokeWidth="3" strokeLinecap="round" className="neon-line" />
                            <circle cx={dragState.currentX} cy={dragState.currentY} r="10" fill={PLAYERS_CONFIG[dragState.sourceId].hex} className="neon-line" />
                        </svg>
                    )}
                </div>
            );
        };
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
